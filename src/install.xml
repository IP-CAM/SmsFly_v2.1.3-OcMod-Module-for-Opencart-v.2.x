<?xml version="1.0" encoding="UTF-8"?>
<modification>
    <name>SMSFly for Opencart 2.0+</name>
    <code>SMSFly Order</code>
    <version>2.2.2</version>
    <author>SMSFlyDev</author>
    <link>https://sms-fly.com</link>
	
	<file path="admin/controller/common/column_left.php">
        <operation>
            <search><![CDATA[// Users]]></search>
            <add position="before"><![CDATA[
			//SMS-Fly
			if ($this->user->hasPermission('access', 'setting/setting')) {
				$system[] = array(
					'name'     => "SMS-Fly",
					'href'     => $this->url->link('setting/sfconfig', 'token=' . $this->session->data['token'], true),
					'children' => array()
				);
			}
			//
			]]>
            </add>
        </operation>
    </file>
	
	<file path="catalog/model/checkout/order.php">
        <operation>
            <search><![CDATA[if ($order_info) {]]></search>
            <add position="before"><![CDATA[
		//SMS_Fly
            if ($this->config->get('sfconfig_alert_client') || $this->config->get('sfconfig_alert_manager')) {
                $sfsuccess = (int)$this->config->get('sfconfig_counter_ok');
                $sferror = (int)$this->config->get('sfconfig_counter_err');

                $sflogin = $this->config->get('sfconfig_gate_username');
                $sfpass = $this->config->get('sfconfig_gate_password');
                $sfai = $this->config->get('sfconfig_from');
                require_once (DIR_SYSTEM . 'library/smsflyc.php');

                $smsfly = new SmsFlyC($sflogin,$sfpass,$sfai);

                $order_status_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "order_status WHERE order_status_id = '" . (int)$order_status_id . "' AND language_id = '" . (int)$order_info['language_id'] . "'");

                if ($order_status_query->num_rows) {
                    $order_status = $order_status_query->row['name'];
                } else {
                    $order_status = '';
                }
            }

            if ($this->config->get('sfconfig_alert_manager')) {
                if ( in_array($order_status_id, $this->config->get('sfconfig_status_check_manager')) ) {
                    $sftemplates = $this->config->get('sfconfig_templates_manager');
                    $sftemplate = $sftemplates[$order_status_id];

                    $sfphonesmng = explode(',',$this->config->get('sfconfig_to_manager'));
                    foreach ($sfphonesmng as $sfphonemng) {
                        $sfsmstext = str_replace(array('{ID}', '{DATE}', '{TIME}', '{SUM}', '{PHONE}', '{NAME}', '{SONAME}', '{STATUS}', '{COMMENT}' ),
                                        array($order_id, date('d.m.Y'), date('H:i'), floatval($order_info['total']), $order_info['telephone'], $order_info['firstname'], $order_info['lastname'] , $order_status, $comment),
                                        $sftemplate);
                        if ($this->config->get('sfconfig_translit') == 1) {
                            $sfsmstext = SmsFlyC::sfTranslit($sfsmstext);
                        }

                        $sfoptions = array(
                            'SMSFLY_PHONE' => $sfphonemng,
                            'SMSFLY_TEXT' => $sfsmstext
                        );
                        $textreturn = $smsfly->sfSendSms($sfoptions);

                        if ($textreturn == "Сообщение отправлено.") {
                            $sfsuccess++;
                            $this->db->query("UPDATE " . DB_PREFIX . "setting SET `value` = '" . $sfsuccess . "' WHERE `key` = 'sfconfig_counter_ok'");
                            if ($this->config->get('sfconfig_copy_to_comment') == 1) {
                                $comment = 'SMS-Fly: '.$sfsmstext;
                            }
                        } else {
                            $sferror++;
                            $this->db->query("UPDATE " . DB_PREFIX . "setting SET `value` = '" . $sferror . "' WHERE `key` = 'sfconfig_counter_err'");
                        }
                    }
                }
            }

            if ($this->config->get('sfconfig_alert_client')) {
                if ( in_array($order_status_id, $this->config->get('sfconfig_status_check_client')) ) {
                    $sftemplates = $this->config->get('sfconfig_templates_client');
                    $sftemplate = $sftemplates[$order_status_id];

                    $sfsmstext = str_replace(array('{ID}', '{DATE}', '{TIME}', '{SUM}', '{PHONE}', '{NAME}', '{SONAME}', '{STATUS}', '{COMMENT}'),
                                    array($order_id, date('d.m.Y'), date('H:i'), floatval($order_info['total']), $order_info['telephone'], $order_info['firstname'], $order_info['lastname'], $order_status, $comment),
                                    $sftemplate);
                    if ($this->config->get('sfconfig_translit') == 1) {
                        $sfsmstext = SmsFlyC::sfTranslit($sfsmstext);
                    }

                    $sfoptions = array(
                        'SMSFLY_PHONE' => $order_info['telephone'],
                        'SMSFLY_TEXT' => $sfsmstext
                    );
                    $textreturn = $smsfly->sfSendSms($sfoptions);

                    if ($textreturn == "Сообщение отправлено.") {
                        $sfsuccess++;
                        $this->db->query("UPDATE " . DB_PREFIX . "setting SET `value` = '" . $sfsuccess . "' WHERE `key` = 'sfconfig_counter_ok'");
                        if ($this->config->get('sfconfig_copy_to_comment') == 1) {
                            $comment = 'SMS-Fly: '.$sfsmstext;
                        }
                    } else {
                        $sferror++;
                        $this->db->query("UPDATE " . DB_PREFIX . "setting SET `value` = '" . $sferror . "' WHERE `key` = 'sfconfig_counter_err'");
                    }
                }
            }
            //
			]]>
            </add>
        </operation>
    </file>	
	
	<file path="admin/controller/common/header.php">
        <operation>
            <search><![CDATA[public function index() {]]></search>
            <add position="after"><![CDATA[
		//SMS_Fly
		if (isset($this->session->data['token'])) {
			$data['sfurl_smsfly'] = 'index.php?route=setting/sfconfig&token=' . $this->session->data['token'];
			$data['sfurl_balance'] = 'index.php?route=setting/sfconfig/asfGetBalance&token=' . $this->session->data['token'];
			$data['sfurl_sendsms'] = 'index.php?route=setting/sfconfig/asfSMSSend&token=' . $this->session->data['token'];
			$data['sfurl_success'] = 'index.php?route=setting/sfconfig/sfCountSucces&token=' . $this->session->data['token'];
			$data['sfurl_error'] = 'index.php?route=setting/sfconfig/sfCountError&token=' . $this->session->data['token'];
		}
		$this->load->language('setting/smsflylang');
		$data['sfentry_otpravitsms'] = $this->language->get('sfentry_otpravitsms');
		$data['sfentry_nomerpoluchat'] = $this->language->get('sfentry_nomerpoluchat');
		$data['sfentry_tekstsoobshenia'] = $this->language->get('sfentry_tekstsoobshenia');
		$data['sfentry_soobshenie'] = $this->language->get('sfentry_soobshenie');
		$data['sfentry_statistika'] = $this->language->get('sfentry_statistika');
		$data['sfentry_oshibok'] = $this->language->get('sfentry_oshibok');
		$data['sfentry_otpravit'] = $this->language->get('sfentry_otpravit');
		$data['sfentry_otpravleno'] = $this->language->get('sfentry_otpravleno');
		$data['sfentry_nastroyki'] = $this->language->get('sfentry_nastroyki');
		$data['sfentry_oshibka'] = $this->language->get('sfentry_oshibka');
		$data['sfentry_balance'] = $this->language->get('sfentry_balance');
		$data['sfentry_nagmite'] = $this->language->get('sfentry_nagmite');

		$data['sfconfig_balance'] = (float)$this->config->get('sfconfig_balance');
		$data['sfconfig_counter_ok'] = (int)$this->config->get('sfconfig_counter_ok');
		$data['sfconfig_counter_err'] = (int)$this->config->get('sfconfig_counter_err');
		//
			]]>
            </add>
        </operation>
    </file>
	
	<file path="admin/view/template/common/header.tpl">
        <operation>
            <search><![CDATA[<ul class="nav pull-right">]]></search>
            <add position="after"><![CDATA[
  <!--SMS-Fly-->
    <li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown"></span> <i class="fa fa-rocket fa-lg"></i></a>
      <ul class="dropdown-menu dropdown-menu-right alerts-dropdown">
        <li class="dropdown-header">SMS-Fly</li>
        <li><a style="cursor: pointer" onclick="sfGetBalance()" title="<?php echo $sfentry_nagmite ?>"><span id="sfbalance" class="label label-success pull-right"><?php echo $sfconfig_balance; ?></span><?php echo $sfentry_balance; ?></a></li>
        <li class="divider"></li>
        <li class="dropdown-header"><?php echo $sfentry_otpravitsms ?>
        <div class="form-group-sm">
            <input id="sfphone" class="form-control" type="text" placeholder="380XXYYYYYYY" style="margin-bottom: 3px; margin-top: 3px;" title="<?php echo $sfentry_nomerpoluchat ?>">
            <textarea id="sftext" class="form-control" placeholder="<?php echo $sfentry_soobshenie ?>" style="margin-bottom: 3px" title="<?php echo $sfentry_tekstsoobshenia ?>"></textarea>
            <input id="sfbutton" class="form-control btn-info" type="button" value="<?php echo $sfentry_otpravit ?>" onclick="sfSendSMS()">
            <label id="sfstatus" hidden></label>
        </div>
        </li>
        <li class="divider"></li>
        <li class="dropdown-header"><?php echo $sfentry_statistika  ?></li>
        <li><a style="display: block; overflow: auto;"><span id="sfsuccess" class="label label-success pull-right"><?php echo $sfconfig_counter_ok; ?></span><?php echo $sfentry_otpravleno  ?></a></li>
        <li><a><span id="sferror" class="label label-danger pull-right"><?php echo $sfconfig_counter_err; ?></span><?php echo $sfentry_oshibok  ?></a></li>
        <li class="divider"></li>
        <li><a href="<?php echo $sfurl_smsfly; ?>"><?php echo $sfentry_nastroyki;  ?></a></li>
      </ul>
    </li>
    <script>
        function sfSendSMS() {
            var postdata = new Object();
            postdata.sfphone = $('#sfphone').val();
            postdata.sftext = $('#sftext').val();

            $('#sfbutton').prop('disabled',true);

            $.ajax({
                url: '<?php echo $sfurl_sendsms ?>',
                type: 'post',
                dataType: 'json',
                data: postdata,
                beforeSend: function () {
                    $('#sfstatus').show();
                },
                success: function(json) {
                    var urlcounter = '<?php echo $sfurl_success ?>';

                    $('#sfstatus').text(json.apiresponse);

                    if (String(json.apiresponse) == "Сообщение отправлено.") {
                        $('#sfsuccess').text(parseInt($('#sfsuccess').text())+1);
                    } else {
                        urlcounter = '<?php echo $sfurl_error ?>';
                        $('#sferror').text(parseInt($('#sferror').text())+1);
                    }
                    $.ajax(urlcounter);
                },
                error: function (err,text) {
                    $('#sfstatus').text('Ошибка');
                    urlcounter = '<?php echo $sfurl_error ?>';
                    $.ajax(urlcounter);
                    console.log(text);
                }
            });
            setTimeout(sfGetBalance,500);
        }

        function sfGetBalance() {
            $.ajax({
                url: '<?php echo $sfurl_balance ?>',
                success: function(response) {
                    $('#sfbalance').text(response + " грн.");
                }
            });
            $('#sfbutton').prop('disabled',false);
        }
    </script>
  <!---->	
			]]>
            </add>
        </operation>
    </file>	
</modification>